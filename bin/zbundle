#!/usr/bin/env bash

set -euo pipefail

# Find the root of the repo
git_root=$(git rev-parse --show-toplevel 2>/dev/null)
if [ -z "$git_root" ]; then
  echo "Not inside a git repository."
  exit 1
fi

dir="$git_root"
pick=false

# process command line args
while [[ $# -gt 0 ]]; do
  case $1 in
  --dir)
    dir="$2"
    shift 2
    ;;
  --pick)
    pick=true
    shift
    ;;
  *)
    echo "Unknown option: $1"
    exit 1
    ;;
  esac
done

# Go to the repo root or selected dir
cd "$dir"

# Make a temp file for the md
md_file=$(mktemp /tmp/zbundle.XXXXXX)
md_file="${md_file}.md"

# Archive only tracked files (respects .gitignore)
mapfile -d '' -t all_files < <(git ls-files -z)

files=("${all_files[@]}")

# If --pick is given, let the user choose with fzf
if $pick; then
  if command -v fzf &>/dev/null; then
    printf '%s\n' "${all_files[@]}" | \
      fzf -m --preview 'bat --style=numbers --color=always --line-range :500 {}' > /tmp/zbundle-selection || true
    if [[ -s /tmp/zbundle-selection ]]; then
      mapfile -t files < /tmp/zbundle-selection
    else
      echo "No files selected, exiting."
      exit 0
    fi
  else
    echo "fzf not installed. Cannot use --pick."
    exit 1
  fi
fi

# Loop over each provided file
for file in "${files[@]}"; do
  if file --mime-type "$file" | grep -q 'text/'; then
    printf "\n### %s\n\n" "$file" >>"$md_file"
    cat "$file" >>"$md_file"
    printf "\n---\n" >>"$md_file"
  else
    echo "Skipping binary file: $file"
  fi
done

# Copy actual file content to clipboard (depends on system)
if command -v xclip &>/dev/null; then
  # Linux with xclip - copy file content
  xclip -selection clipboard <"$md_file"
  echo "Markdown file contents copied to clipboard: $md_file"
elif command -v pbcopy &>/dev/null; then
  # macOS - copy file content
  pbcopy <"$md_file"
  echo "Markdown file contents copied to clipboard: $md_file"
elif command -v wl-copy &>/dev/null; then
  # Wayland clipboard - copy file content
  wl-copy <"$md_file"
  echo "Markdown file contents copied to clipboard: $md_file"
else
  echo "No clipboard tool found. Markdown file at: $md_file"
  exit 1
fi

exit 0