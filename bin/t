#!/usr/bin/env bash
# t â€“ tmux swiss army knife (cached templates + pane/window launcher)

# --- Colors & Symbols ---
GREEN="\033[1;32m"; YELLOW="\033[1;33m"; GRAY="\033[0;37m"; RESET="\033[0m"
RUNNING_ICON="â–¶"; TEMPLATE_ICON="â—"; ADHOC_ICON="â—‹"

inside_tmux=$(tmux display-message -p '#{client_name}' 2>/dev/null)

# --- Template cache ---
CACHE_DIR="$HOME/.cache/dotfiles/t"
CACHE_FILE="$CACHE_DIR/templates.txt"
CACHE_TTL=$((18 * 60 * 60)) # 18 hours

mkdir -p "$CACHE_DIR"

rebuild_cache() {
  echo "ðŸ” Rebuilding template cache..."
  find ~/src -maxdepth 3 -type f -name tmux-session.conf -exec dirname {} \; | sort -u > "$CACHE_FILE"
}

if [[ ! -f "$CACHE_FILE" ]] || (( $(date +%s) - $(date -r "$CACHE_FILE" +%s) > CACHE_TTL )); then
  rebuild_cache
fi

template_dirs=$(cat "$CACHE_FILE")
template_names=$(basename -a $template_dirs 2>/dev/null | sort -u)

running_sessions=$(tmux ls -F '#{session_name}' 2>/dev/null | sort -u)
all_names=$(printf "%s\n%s\n" "$running_sessions" "$template_names" | sort -u)

# --- Build menu ---
combined=$(
  for n in $all_names; do
    has_conf=$(grep -Fx "$HOME/src/$n" "$CACHE_FILE" 2>/dev/null || true)
    if echo "$running_sessions" | grep -qx "$n"; then
      if [ -n "$has_conf" ]; then
        printf "${GREEN}${RUNNING_ICON}${RESET}  %-18s â†’ Switch to (template)\n" "$n"
      else
        printf "${GREEN}${RUNNING_ICON}${RESET}  %-18s â†’ Switch to (ad-hoc)\n" "$n"
      fi
    else
      if [ -n "$has_conf" ]; then
        printf "${YELLOW}${TEMPLATE_ICON}${RESET}  %-18s â†’ Start (template)\n" "$n"
      else
        printf "${GRAY}${ADHOC_ICON}${RESET}  %-18s â†’ Unknown\n" "$n"
      fi
    fi
  done
)

session=$( (echo -e "$combined"
            [ -n "$inside_tmux" ] && echo "âï¸  Detach"
            [ -n "$inside_tmux" ] && echo "âœï¸  Rename Current Session"
            echo "â™»ï¸  Reread Template Cache"
            echo "âž•  New Session") \
  | fzf --ansi --height 40% --reverse --prompt='tmux session > ' --border --no-sort) || exit 0

name=$(awk '{print $2}' <<< "$session")

case "$session" in
  *"Reread Template Cache"*)
    rebuild_cache
    echo "âœ… Template cache refreshed."
    sleep 1
    exec "$0"
    ;;

  *"New Session"*)
    read -rp "Enter new session name: " newname
    if [ -n "$inside_tmux" ]; then
      [ -n "$newname" ] && tmux new-session -d -s "$newname" && tmux switch-client -t "$newname" \
        || { tmux new-session -d && tmux switch-client -t "$(tmux display-message -p '#S')"; }
    else
      [ -n "$newname" ] && tmux new -s "$newname" || tmux new
    fi
    ;;

  *"Rename Current Session"*)
    current=$(tmux display-message -p '#S')
    read -rp "Rename current session ('$current') to: " newname
    [ -n "$newname" ] && tmux rename-session -t "$current" "$newname"
    ;;

  *"Detach"*)
    tmux detach-client
    ;;

  *)
    if tmux has-session -t "$name" 2>/dev/null; then
      [ -n "$inside_tmux" ] && tmux switch-client -t "$name" || tmux attach -t "$name"
      exit 0
    fi

    conf_path=$(find ~/src -maxdepth 3 -type f -name tmux-session.conf -path "*/$name/*" -print -quit)
    if [[ -n "$conf_path" ]]; then
      echo -e "${YELLOW}âš™ï¸  Creating new session from template:${RESET} $name"
      dir=$(dirname "$conf_path")
      source "$conf_path"

      if ! tmux has-session -t "$SESSION" 2>/dev/null; then
        if [[ -n "${PANES[*]}" ]]; then
          tmux new-session -d -s "$SESSION" -c "$dir" -n $(cut -d: -f1 <<< "${PANES[0]}")
          first_cmd=$(cut -d: -f2- <<< "${PANES[0]}")
          [[ -n "$first_cmd" ]] && tmux send-keys -t "$SESSION:0" "$first_cmd" C-m

          if ((${#PANES[@]} > 1)); then
            for i in "${PANES[@]:1}"; do
              cmd=$(cut -d: -f2- <<< "$i")
              tmux split-window -t "$SESSION:0" -v -c "$dir"
              [[ -n "$cmd" ]] && tmux send-keys -t "$SESSION:0" "$cmd" C-m
              tmux select-layout -t "$SESSION:0" tiled
            done
          fi

        elif [[ -n "${WINDOWS[*]}" ]]; then
          tmux new-session -d -s "$SESSION" -c "$dir" -n $(cut -d: -f1 <<< "${WINDOWS[0]}")
          first_cmd=$(cut -d: -f2- <<< "${WINDOWS[0]}")
          [[ -n "$first_cmd" ]] && tmux send-keys -t "$SESSION:0" "$first_cmd" C-m

          for i in "${WINDOWS[@]:1}"; do
            name=$(cut -d: -f1 <<< "$i")
            dir=$(cut -d: -f3 <<< "$i")
            cmd=$(cut -d: -f2- <<< "$i")
            [[ -d "$dir" ]] || dir="$root_dir/$dir"
            tmux new-window -t "$SESSION:" -n "$name" -c "$dir"
            [[ -n "$cmd" ]] && tmux send-keys -t "$SESSION:$name" "$cmd" C-m
          done
        fi
      fi

      [ -n "$inside_tmux" ] && tmux switch-client -t "$SESSION" || tmux attach -t "$SESSION"
      tmux select-layout -t "$SESSION:0" tiled
      exit 0
    else
      echo "âŒ No tmux-session.conf found for '$name'"
    fi
    ;;
esac