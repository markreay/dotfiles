#!/bin/bash

set -e

# Find the root of the repo
git_root=$(git rev-parse --show-toplevel 2>/dev/null)
if [ -z "$git_root" ]; then
  echo "Not inside a git repository."
  exit 1
fi

# Go to the repo root
cd "$git_root"

# Make a temp file for the zip
zipfile=$(mktemp /tmp/forzoe-XXXXXX.zip)
rm -f "$zipfile"

# Archive only tracked files (respects .gitignore)
git ls-files -z | xargs -0 zip "$zipfile"

# Copy actual file content to clipboard (depends on system)
if grep -qEi "microsoft" /proc/version &> /dev/null; then
  # WSL detected - use powershell.exe to copy file properly
  powershell.exe -Command Set-Clipboard -Path $(wslpath -w "$zipfile")
  echo "Zip file reference copied to Windows clipboard: $zipfile"
elif command -v pbcopy &> /dev/null; then
  # macOS - copy file content
  pbcopy < "$zipfile"
  echo "Zip file contents copied to clipboard: $zipfile"
elif command -v xclip &> /dev/null; then
  # Linux with xclip - copy file content
  xclip -selection clipboard -t application/zip -i "$zipfile"
  echo "Zip file contents copied to clipboard: $zipfile"
elif command -v wl-copy &> /dev/null; then
  # Wayland clipboard - copy file content
  wl-copy < "$zipfile"
  echo "Zip file contents copied to clipboard: $zipfile"
else
  echo "No clipboard tool found. Zip file at: $zipfile"
fi

exit 0
